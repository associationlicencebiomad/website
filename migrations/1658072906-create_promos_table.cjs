exports.up = async (client) => {
	// create promos table
	await client`
        create table public.promos
        (
            id   bigint generated by default as identity primary key,
            year smallint not null,
            name text     not null
        );
	`;

	// Enable RLS
	await client`
        alter table public.promos
            enable row level security;
	`;

	// Create Policy
	await client`
        create policy "Promos are viewable by everyone."
        on promos for select using (
            true
        );
    `;

	// 4. create a promo_key table, to keep these keys privates ...
	await client`
        create table public.promo_key
        (
            id  bigint primary key not null references public.promos (id) on delete cascade,
            key text unique        not null
        );
	`;

	// 5. enable RLS on promo_key
	await client`
        alter table public.promo_key
            enable row level security;
	`;

	// 6. Create Policy
	await client`
        CREATE POLICY "Promo_key are restricted to authenticated user"
        ON public.promo_key
        FOR select using
        (auth.role() = 'authenticated');
    `;
};

exports.down = async (client) => {
	// Disable RLS
	await client`
        alter table public.promos
            disable row level security;
	`;
	await client`
        alter table public.promo_key
            disable row level security;
	`;

	// Remove Policy
	await client`
        drop policy "Promos are viewable by everyone."
        on promos;
    `;

	await client`
        drop policy "Promo_key are restricted to authenticated user"
        on promo_key;
    `;

	// drop tables
	await client`
        drop table public.promo_key;
	`;

	await client`
        drop table public.promos;
	`;
};
